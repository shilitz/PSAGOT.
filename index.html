<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פסגות | ProTrack Control</title>
<link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        :root { --psagot-purple: #4e1d4e; --psagot-magenta: #c12080; }
        body { font-family: 'Assistant', sans-serif; background: #fdf2f8; text-align: right; margin: 0; }
        .completed-row { opacity: 0.5; background-color: #f1f5f9; text-decoration: line-through; border-right: 4px solid #cbd5e1 !important; }
        .timer-active { color: var(--psagot-magenta); font-weight: 900; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.05); } }
        .modal { display: none; position: fixed; z-index: 100; inset: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.open { display: flex; }
        .logo-container img { height: 50px; width: auto; }
        .live-task { border-right: 4px solid var(--psagot-magenta); background: #fff1f2; }
    </style>
</head>
<body class="min-h-screen">

    <div id="editModal" class="modal p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-right">
            <h3 class="text-2xl font-black mb-6 text-purple-900">עריכת משימה</h3>
            <input id="editId" type="hidden">
            <div class="space-y-4">
                <input id="editTitle" type="text" class="w-full p-3 border rounded-xl outline-none" placeholder="שם המשימה">
                <input id="editDesc" type="text" class="w-full p-3 border rounded-xl outline-none" placeholder="תיאור">
                <div class="grid grid-cols-2 gap-4">
                    <input id="editTime" type="time" class="p-3 border rounded-xl w-full">
                    <select id="editRecur" class="p-3 border rounded-xl w-full">
                        <option value="חד פעמי">חד פעמי</option>
                        <option value="יומי">יומי</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="saveEdit()" class="flex-1 bg-[#c12080] text-white py-3 rounded-xl font-bold">שמור</button>
                <button onclick="closeEdit()" class="flex-1 bg-slate-200 py-3 rounded-xl font-bold">ביטול</button>
            </div>
        </div>
    </div>

    <div id="loginOverlay" class="fixed inset-0 z-[9999] bg-[#4e1d4e] flex items-center justify-center">
        <div class="bg-white/10 backdrop-blur-md p-10 rounded-[2rem] border border-white/20 text-center w-80">
            <img src="logo.png" alt="פסגות" class="mx-auto mb-6 brightness-0 invert h-20">
            <input id="loginUser" type="text" placeholder="שם משתמש" class="w-full p-4 rounded-xl mb-4 text-center outline-none">
            <button onclick="handleLogin()" class="w-full bg-[#c12080] text-white font-bold py-4 rounded-xl shadow-lg">כניסה</button>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
            <div class="flex gap-6 items-center">
                <div class="logo-container"><img src="logo.png" alt="פסגות"></div>
                <span id="userNameDisplay" class="font-bold text-[#4e1d4e] border-r-2 pr-4 mr-2"></span>
                <div class="bg-slate-100 p-1 rounded-lg flex gap-1">
                    <button onclick="switchTab('tasks')" id="tBtn" class="px-4 py-1.5 rounded-md text-sm font-bold bg-white shadow-sm text-purple-700">משימות</button>
                    <button onclick="switchTab('admin')" id="aBtn" class="hidden px-4 py-1.5 rounded-md text-sm font-bold text-slate-500">ניהול ודוחות</button>
                </div>
            </div>
            <button onclick="logout()" class="text-rose-500 text-xs font-bold">יציאה</button>
        </nav>

        <main class="p-6 max-w-7xl mx-auto">
            <div id="sectionTasks" class="space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border-t-4 border-[#c12080]">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input id="inTitle" type="text" placeholder="מה המשימה?" class="p-4 bg-slate-50 rounded-2xl border text-right outline-none">
                        <input id="inDesc" type="text" placeholder="הערות" class="p-4 bg-slate-50 rounded-2xl border text-right outline-none">
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <select id="inTargetUser" class="p-3 bg-slate-50 rounded-xl border font-bold outline-none"></select>
                        <input id="inTime" type="time" class="p-3 bg-slate-50 rounded-xl border outline-none">
                        <select id="inRecur" class="p-3 bg-slate-50 rounded-xl border outline-none">
                            <option value="חד פעמי">חד פעמי</option>
                            <option value="יומי">יומי</option>
                        </select>
                        <button onclick="addTask()" class="bg-[#4e1d4e] text-white font-black rounded-xl hover:bg-black transition-colors">הוסף +</button>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-lg overflow-hidden border">
                    <table class="w-full text-right border-collapse">
                        <thead class="bg-slate-50 text-[#4e1d4e] text-xs font-black border-b">
                            <tr><th class="p-4">זמן</th><th class="p-4">משימה</th><th class="p-4 text-center">טיימר</th><th class="p-4 text-center">פעולות</th></tr>
                        </thead>
                        <tbody id="workerTable" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="sectionAdmin" class="hidden space-y-8">
                <div class="flex justify-between items-center border-b pb-6">
                    <div>
                        <h2 class="text-3xl font-black text-[#4e1d4e]">דוחות וביצועים</h2>
                        <div class="mt-2 flex gap-4">
                            <button onclick="downloadTemplate()" class="text-blue-600 text-xs font-bold underline">תבנית אקסל</button>
                            <label class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-xs cursor-pointer font-bold">
                                ייבוא משימות (CSV)
                                <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="importCSV(event)">
                            </label>
                        </div>
                    </div>
                    <div id="adminManagementPanel" class="hidden flex gap-2">
                         <input id="adminListInput" type="text" placeholder="שמות מנהלים" class="p-2 border rounded-lg text-xs w-48">
                         <button onclick="updateAdminsList()" class="bg-[#4e1d4e] text-white px-3 py-2 rounded-lg text-xs font-bold">עדכן מנהלים</button>
                    </div>
                </div>
                <div id="adminStats" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
            </div>
        </main>
    </div>

    <script>
        const SB_URL = 'https://ytcthmwkmvajmfegnqas.supabase.co';
        const SB_KEY = 'sb_publishable_zFfoc_9qq0d__uyeyUUqZA_OQ4m5_o3';
        const _s = supabase.createClient(SB_URL, SB_KEY);
        
        let user = localStorage.getItem('pro_u');
        let allTasks = [];
        let admins = ["שלום שיליץ"];

        if(user) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = `שלום, ${user}`;
            sync();
        }

        async function handleLogin() {
            const val = document.getElementById('loginUser').value.trim();
            if(!val) return;
            localStorage.setItem('pro_u', val);
            location.reload();
        }

        async function sync() {
            const { data: tasks } = await _s.from('tasks').select('*').order('scheduled_time', { ascending: true });
            allTasks = tasks || [];
            const { data: set } = await _s.from('settings').select('*').eq('key', 'admin_users');
            if(set && set[0]) admins = set[0].value;
            const isAdmin = admins.includes(user);
            document.getElementById('aBtn').classList.toggle('hidden', !isAdmin);
            if(isAdmin) {
                document.getElementById('adminManagementPanel').classList.remove('hidden');
                document.getElementById('adminListInput').value = admins.join(', ');
                renderAdminUI();
            }
            updateUserList();
            renderWorkerUI();
        }

        function renderWorkerUI() {
            const today = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById('workerTable');
            const myTasks = allTasks.filter(t => t.worker_name === user);
            const active = myTasks.filter(t => t.status !== 'הושלם' && t.last_completed_date !== today);
            const done = myTasks.filter(t => t.status === 'הושלם' || t.last_completed_date === today);
            const sorted = [...active, ...done];

            tbody.innerHTML = sorted.map(t => {
                const isDone = (t.status === 'הושלם') || (t.last_completed_date === today);
                return `<tr class="${isDone ? 'completed-row' : ''}">
                    <td class="p-4 font-black text-[#4e1d4e]">${t.scheduled_time?.slice(0,5) || '--:--'}</td>
                    <td class="p-4"><div class="font-bold text-slate-800">${t.title}</div><div class="text-[10px] text-slate-400 font-bold">${t.description || ''}</div></td>
                    <td class="p-4 text-center"><div id="timer-${t.id}" class="font-mono text-xl ${t.is_running ? 'timer-active' : 'text-slate-300'}">${formatTime(t.total_seconds, t.is_running ? t.last_start : null)}</div></td>
                    <td class="p-4 text-center flex justify-center gap-2">
                        ${!isDone ? `<button onclick="toggleTimer('${t.id}')" class="bg-slate-100 px-4 py-2 rounded-xl text-[10px] font-black">${t.is_running ? 'עצור' : 'הפעל'}</button><button onclick="finishTask('${t.id}')" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">בוצע</button>` : `<button onclick="undoTask('${t.id}')" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-[10px]">שחזור ↺</button>`}
                        <button onclick="openEdit('${t.id}')" class="text-slate-300 px-2 hover:text-[#c12080]">✎</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderAdminUI() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const workers = {};
            allTasks.forEach(t => { if(!workers[t.worker_name]) workers[t.worker_name] = []; workers[t.worker_name].push(t); });

            document.getElementById('adminStats').innerHTML = Object.entries(workers).map(([name, tasks]) => {
                const running = tasks.filter(t => t.is_running);
                const dailyDone = tasks.filter(t => t.last_completed_date === todayStr || t.status === 'הושלם').length;
                const dailyPercent = Math.round((dailyDone / (tasks.length || 1)) * 100);
                const monthlyDone = tasks.filter(t => (t.last_completed_date && t.last_completed_date >= startOfMonth) || t.status === 'הושלם').length;
                const monthlyPercent = Math.min(100, Math.round((monthlyDone / (tasks.length || 1)) * 100));

                return `<div class="bg-white rounded-[2rem] shadow-sm border overflow-hidden mb-4">
                    <div class="bg-[#4e1d4e] p-5 text-white flex justify-between items-center">
                        <div><h3 class="text-xl font-black italic">${name}</h3></div>
                        <div class="flex gap-4 text-center">
                            <div><div class="text-xl font-black text-fuchsia-300">${dailyPercent}%</div><div class="text-[8px]">יומי</div></div>
                            <div><div class="text-xl font-black text-emerald-300">${monthlyPercent}%</div><div class="text-[8px]">חודשי</div></div>
                        </div>
                    </div>
                    <div class="p-5 space-y-3">
                        ${running.map(t => `<div class="live-task p-3 rounded-xl flex justify-between items-center"><span class="text-xs font-bold text-[#4e1d4e]">${t.title}</span><span id="admin-timer-${t.id}" class="font-mono text-lg font-black text-rose-600 animate-pulse">${formatTime(t.total_seconds, t.last_start)}</span></div>`).join('')}
                        <details class="group mt-2">
                            <summary class="list-none cursor-pointer text-center py-2 bg-slate-50 rounded-lg text-[10px] font-bold text-slate-400">פירוט משימות</summary>
                            <div class="mt-2 space-y-1 text-[10px]">${tasks.map(t => `<div class="flex justify-between p-1 border-b"><span>${t.title}</span><span>${formatTime(t.total_seconds, t.is_running ? t.last_start : null)}</span></div>`).join('')}</div>
                        </details>
                    </div>
                </div>`;
            }).join('');
        }

        async function addTask() {
            const title = document.getElementById('inTitle').value.trim();
            const target = document.getElementById('inTargetUser').value;
            if(!title) return;
            
            let names = target === 'כולם' ? [...new Set(allTasks.map(t => t.worker_name))] : [target === 'self' ? user : target];
            
            // הסרת hour_range מהאובייקט למניעת השגיאה מול ה-Schema
            const rows = names.map(n => ({
                title, 
                worker_name: n, 
                description: document.getElementById('inDesc').value || "",
                scheduled_time: document.getElementById('inTime').value || "00:00:00",
                recurrence: document.getElementById('inRecur').value, 
                status: 'בביצוע'
            }));

            const { error } = await _s.from('tasks').insert(rows);
            if(error) { alert("שגיאה: " + error.message); }
            else { 
                document.getElementById('inTitle').value = ''; 
                document.getElementById('inDesc').value = '';
                sync(); 
            }
        }

        function updateUserList() {
            const users = [...new Set(allTasks.map(t => t.worker_name))].filter(u => u);
            let opts = `<option value="self">עבורי (${user})</option><option value="כולם">כל הצוות</option>`;
            users.forEach(u => { if(u !== user) opts += `<option value="${u}">${u}</option>`; });
            document.getElementById('inTargetUser').innerHTML = opts;
        }

        function formatTime(tot, start) {
            let s = tot || 0; if(start) s += Math.floor((new Date() - new Date(start)) / 1000);
            const h = Math.floor(s/3600).toString().padStart(2,'0'), m = Math.floor((s%3600)/60).toString().padStart(2,'0'), sec = (s%60).toString().padStart(2,'0');
            return `${h}:${m}:${sec}`;
        }

        async function toggleTimer(id) {
            const t = allTasks.find(x => String(x.id) === String(id));
            const now = new Date().toISOString();
            let up = t.is_running ? { is_running: false, total_seconds: (t.total_seconds || 0) + Math.floor((new Date() - new Date(t.last_start)) / 1000), last_start: null } : { is_running: true, last_start: now };
            await _s.from('tasks').update(up).eq('id', id);
            sync();
        }

        async function finishTask(id) {
            const t = allTasks.find(x => String(x.id) === String(id));
            const today = new Date().toISOString().split('T')[0];
            let sec = t.total_seconds || 0;
            if(t.is_running) sec += Math.floor((new Date() - new Date(t.last_start)) / 1000);
            await _s.from('tasks').update({ is_running: false, last_start: null, total_seconds: sec, last_completed_date: today, status: t.recurrence === 'יומי' ? 'בביצוע' : 'הושלם' }).eq('id', id);
            sync();
        }

        async function undoTask(id) { await _s.from('tasks').update({ status: 'בביצוע', last_completed_date: null, total_seconds: 0, is_running: false }).eq('id', id); sync(); }

        function openEdit(id) {
            const t = allTasks.find(x => String(x.id) === String(id));
            if(!t) return;
            document.getElementById('editId').value = t.id;
            document.getElementById('editTitle').value = t.title;
            document.getElementById('editDesc').value = t.description || '';
            document.getElementById('editTime').value = t.scheduled_time || '00:00';
            document.getElementById('editRecur').value = t.recurrence;
            document.getElementById('editModal').classList.add('open');
        }

        async function saveEdit() {
            const id = document.getElementById('editId').value;
            await _s.from('tasks').update({ title: document.getElementById('editTitle').value, description: document.getElementById('editDesc').value, scheduled_time: document.getElementById('editTime').value, recurrence: document.getElementById('editRecur').value }).eq('id', id);
            closeEdit(); sync();
        }
        function closeEdit() { document.getElementById('editModal').classList.remove('open'); }

        function downloadTemplate() {
            const csv = "worker_name,title,description,scheduled_time,recurrence\nישראל,משימה,תיאור,08:00,יומי";
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "template.csv"; link.click();
        }

        function importCSV(e) {
            const f = e.target.files[0]; if(!f) return;
            Papa.parse(f, { header: true, skipEmptyLines: true, complete: async (r) => { await _s.from('tasks').insert(r.data.map(row => ({...row, status: 'בביצוע'}))); sync(); } });
        }

        function switchTab(t) {
            const isT = t === 'tasks';
            document.getElementById('sectionTasks').classList.toggle('hidden', !isT);
            document.getElementById('sectionAdmin').classList.toggle('hidden', isT);
            document.getElementById('tBtn').className = isT ? "px-4 py-1.5 rounded-md text-sm font-bold bg-white shadow-sm text-purple-700" : "px-4 py-1.5 rounded-md text-sm font-bold text-slate-500";
            document.getElementById('aBtn').className = !isT ? "px-4 py-1.5 rounded-md text-sm font-bold bg-white shadow-sm text-purple-700" : "px-4 py-1.5 rounded-md text-sm font-bold text-slate-500";
        }

        async function updateAdminsList() {
            const newList = document.getElementById('adminListInput').value.split(',').map(s => s.trim()).filter(s => s !== "");
            await _s.from('settings').upsert({ key: 'admin_users', value: newList }, { onConflict: 'key' });
            sync();
        }

        function logout() { localStorage.clear(); location.reload(); }
        
        setInterval(() => {
            document.querySelectorAll('[id^="timer-"], [id^="admin-timer-"]').forEach(el => {
                const id = el.id.includes('admin') ? el.id.replace('admin-timer-', '') : el.id.replace('timer-', '');
                const t = allTasks.find(x => String(x.id) === id);
                if(t && t.is_running) el.innerText = formatTime(t.total_seconds, t.last_start);
            });
        }, 1000);

        _s.channel('db').on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, () => sync()).subscribe();
    </script>
</body>
</html>





