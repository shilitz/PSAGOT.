<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×¡×’×•×ª | ProTrack - × ×™×”×•×œ ×‘×™×¦×•×¢×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f8fafc; text-align: right; margin: 0; overflow-x: hidden; }
        
        #loginOverlay {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(135deg, #4c1d95 0%, #701a75 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 3rem; border-radius: 3rem; width: 100%; max-width: 420px; text-align: center;
        }

        .period-btn { background: white; color: #64748b; border: 1px solid #e2e8f0; }
        .period-btn.active { background: #701a75; color: white; border-color: #701a75; box-shadow: 0 4px 12px rgba(112, 26, 117, 0.3); }
        
        .modal { display: none; position: fixed; z-index: 100; inset: 0; background: rgba(46, 16, 101, 0.85); align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal.open { display: flex; }
        
        /* ×¢×™×¦×•×‘ ×œ××©×™××” ×¤×¢×™×œ×” ×›×¨×’×¢ */
        .active-task { 
            background: #fff1f2 !important; 
            border-right: 8px solid #f43f5e !important;
            animation: activeGlow 2s infinite ease-in-out;
        }
        @keyframes activeGlow {
            0% { box-shadow: inset 0 0 0px #f43f5e33; }
            50% { box-shadow: inset 0 0 15px #f43f5e33; }
            100% { box-shadow: inset 0 0 0px #f43f5e33; }
        }
        .active-badge {
            background: #f43f5e; color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 800;
            animation: blink 1s infinite; margin-right: 8px;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

        .stat-card { transition: all 0.3s ease; border-right: 6px solid #701a75; }
        .completed-row { opacity: 0.6; background-color: #fdf4ff; }
        
        .separator { border-top: 3px dashed #d8b4fe; margin: 20px 0; position: relative; }
        .separator::after { content: '×”××©×š ×”×œ×•"×–'; position: absolute; top: -12px; right: 20px; background: #f8fafc; padding: 0 10px; font-size: 12px; font-weight: bold; color: #a21caf; }
        
        input, select { text-align: right; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div id="loginOverlay">
        <div class="login-card">
            <h1 class="text-4xl font-black text-white mb-8">×¤×¡×’×•×ª</h1>
            <div class="space-y-4">
                <input id="loginUser" type="text" placeholder="×©× ××©×ª××©" class="w-full p-4 bg-white/10 border border-white/10 rounded-2xl text-white text-center outline-none text-xl placeholder-white/50">
                <button onclick="handleLogin()" class="w-full bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-black py-4 rounded-2xl shadow-xl transition-all active:scale-95 text-lg">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
            </div>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <div id="editModal" class="modal p-4">
            <div class="bg-white p-8 rounded-[2rem] shadow-2xl w-full max-w-md">
                <h3 id="modalTitle" class="text-2xl font-black mb-6 text-purple-900">×”×’×“×¨×ª ××©×™××”</h3>
                <input id="editId" type="hidden">
                <div class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500">×›×•×ª×¨×ª ×”××©×™××”</label><input id="editTitle" type="text" class="w-full p-3 bg-slate-50 border rounded-xl outline-none"></div>
                    
                    <div>
                        <label class="text-xs font-bold text-slate-500">××—×–×•×¨×™×•×ª</label>
                        <select id="editRecur" onchange="toggleHourlyFields()" class="w-full p-3 bg-slate-50 border rounded-xl">
                            <option value="×—×“ ×¤×¢××™">×—×“ ×¤×¢××™ (×©×¢×” ×¡×¤×¦×™×¤×™×ª)</option>
                            <option value="×©×¢×ª×™">×©×¢×ª×™ (×˜×•×•×— ×©×¢×•×ª)</option>
                            <option value="×™×•××™">×™×•××™ (×›×œ ×‘×•×§×¨)</option>
                        </select>
                    </div>

                    <div id="singleTimeField">
                        <label class="text-xs font-bold text-slate-500">×©×¢×ª ×™×¢×“</label>
                        <input id="editTime" type="time" class="w-full p-3 bg-slate-50 border rounded-xl">
                    </div>

                    <div id="hourlyFields" class="hidden grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500">××©×¢×”</label><input id="startHour" type="time" value="08:00" class="w-full p-3 bg-slate-50 border rounded-xl"></div>
                        <div><label class="text-xs font-bold text-slate-500">×¢×“ ×©×¢×”</label><input id="endHour" type="time" value="18:00" class="w-full p-3 bg-slate-50 border rounded-xl"></div>
                    </div>

                    <div><label class="text-xs font-bold text-slate-500">×©× ×”×¢×•×‘×“</label><input id="editWorker" type="text" class="w-full p-3 bg-slate-50 border rounded-xl outline-none"></div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button onclick="saveTask()" class="flex-1 bg-fuchsia-600 text-white font-bold py-3 rounded-xl">×©××•×¨</button>
                    <button onclick="closeEdit()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl">×‘×™×˜×•×œ</button>
                </div>
            </div>
        </div>

        <nav class="bg-white/90 backdrop-blur-md sticky top-0 z-40 px-6 py-4 flex justify-between items-center border-b border-purple-100 shadow-sm">
            <div class="flex items-center gap-8">
                <span class="text-2xl font-black text-purple-900">×¤×¡×’×•×ª</span>
                <div class="flex gap-1 bg-slate-100 p-1 rounded-xl">
                    <button onclick="setPeriod('day')" id="dayBtn" class="period-btn px-6 py-2 rounded-lg font-bold transition-all active">×™×•×</button>
                    <button onclick="setPeriod('month')" id="monthBtn" class="period-btn px-6 py-2 rounded-lg font-bold transition-all">×—×•×“×©</button>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="currentUserDisplay" class="font-bold text-purple-900"></span>
                <button onclick="logout()" class="text-slate-400 hover:text-red-500 font-bold">×™×¦×™××”</button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-6 space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stat-card bg-white p-8 rounded-3xl shadow-sm">
                    <p class="text-slate-500 font-bold mb-1">×‘×™×¦×•×¢×™× ×¢×“ ×›×” (×œ×”×™×•×)</p>
                    <div class="flex items-end gap-2">
                        <h2 id="currentScore" class="text-5xl font-black text-purple-950">0%</h2>
                        <span id="scoreTrend" class="text-sm font-bold text-emerald-500 mb-2">×ª×§×™×Ÿ</span>
                    </div>
                </div>
                <div class="stat-card bg-white p-8 rounded-3xl shadow-sm border-r-fuchsia-500">
                    <p class="text-slate-500 font-bold mb-1">××©×™××•×ª ×©×”×•×©×œ××•</p>
                    <h2 id="tasksCount" class="text-5xl font-black text-purple-950">0/0</h2>
                </div>
                <div id="adminPanel" class="stat-card bg-purple-900 p-8 rounded-3xl shadow-sm border-none hidden">
                    <p class="text-purple-200 font-bold mb-3">× ×™×”×•×œ ×× ×”×œ×™×</p>
                    <button onclick="openNewTask()" class="w-full bg-white/10 text-white border border-white/20 py-3 rounded-xl font-bold hover:bg-white/20">+ ×”×•×¡×¤×ª ××©×™××”</button>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-8 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                    <h2 class="text-2xl font-black text-purple-950">×œ×•"×– ××©×™××•×ª ××¤×•×¨×˜</h2>
                    <div class="flex gap-3">
                        <button onclick="importCSV()" class="bg-white text-slate-700 border px-6 py-3 rounded-2xl font-bold hover:bg-slate-50 transition-all flex items-center gap-2">
                            <span>ğŸ“¤</span> ×™×™×‘×•× CSV
                        </button>
                        <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="processCSV(event)">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-right text-slate-400 text-sm uppercase tracking-widest">
                                <th class="p-6 font-bold">×©×¢×”</th>
                                <th class="p-6 font-bold">××©×™××”</th>
                                <th class="p-6 font-bold">×¢×•×‘×“</th>
                                <th class="p-6 font-bold">×¡×˜×˜×•×¡</th>
                                <th class="p-6 font-bold">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = localStorage.getItem('proTrackUser') || null;
        let baseTasks = [];
        let admins = ['admin', 'manager']; // × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×˜×¢×™× ×” ××”-DB

        async function init() {
            if (currentUser) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('currentUserDisplay').innerText = `×©×œ×•×, ${currentUser}`;
                if (admins.includes(currentUser)) document.getElementById('adminPanel').classList.remove('hidden');
                loadTasks();
                setInterval(renderTasks, 30000); 
            }
        }

        async function loadTasks() {
            const { data } = await supabase.from('tasks').select('*');
            if (data) {
                baseTasks = data;
                renderTasks();
            }
        }

        function toggleHourlyFields() {
            const recur = document.getElementById('editRecur').value;
            document.getElementById('hourlyFields').classList.toggle('hidden', recur !== '×©×¢×ª×™');
            document.getElementById('singleTimeField').classList.toggle('hidden', recur === '×©×¢×ª×™');
        }

        function renderTasks() {
            const tbody = document.getElementById('taskTableBody');
            tbody.innerHTML = '';
            
            const now = new Date();
            const currentTimeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');

            let expandedTasks = [];
            baseTasks.forEach(task => {
                if (task.recurrence === '×©×¢×ª×™' && task.start_hour && task.end_hour) {
                    let start = parseInt(task.start_hour.split(':')[0]);
                    let end = parseInt(task.end_hour.split(':')[0]);
                    for (let h = start; h <= end; h++) {
                        expandedTasks.push({
                            ...task,
                            target_time: h.toString().padStart(2, '0') + ":00",
                            instance_id: `${task.id}-${h}`
                        });
                    }
                } else {
                    expandedTasks.push({ ...task, instance_id: task.id });
                }
            });

            expandedTasks.sort((a, b) => a.target_time.localeCompare(b.target_time));

            let totalRequiredToday = 0;
            let completedToday = 0;
            let activeTaskFound = false;
            let separatorAdded = false;

            expandedTasks.forEach(task => {
                const isPast = task.target_time <= currentTimeStr;
                const isCompleted = task.is_completed;
                
                // ×—×™×©×•×‘ ×¨×§ ××”×™×•×
                if (isPast) {
                    totalRequiredToday++;
                    if (isCompleted) completedToday++;
                }

                const isActive = !activeTaskFound && !isCompleted && (task.target_time >= currentTimeStr || task.target_time.split(':')[0] == now.getHours());
                if (isActive) activeTaskFound = true;

                if (!separatorAdded && task.target_time > currentTimeStr) {
                    const sep = document.createElement('tr');
                    sep.innerHTML = `<td colspan="5"><div class="separator"></div></td>`;
                    tbody.appendChild(sep);
                    separatorAdded = true;
                }

                const tr = document.createElement('tr');
                tr.className = `transition-all ${isCompleted ? 'completed-row' : ''} ${isActive ? 'active-task font-bold' : 'hover:bg-slate-50'}`;
                
                tr.innerHTML = `
                    <td class="p-6 font-bold text-purple-900">${task.target_time}</td>
                    <td class="p-6">
                        <div class="flex items-center">
                            ${isActive ? '<span class="active-badge">×‘×‘×™×¦×•×¢</span>' : ''}
                            <span class="text-slate-800">${task.title}</span>
                        </div>
                    </td>
                    <td class="p-6 text-slate-600">${task.worker_name || '-'}</td>
                    <td class="p-6">
                        <span class="px-3 py-1 rounded-full text-xs font-black ${isCompleted ? 'bg-emerald-100 text-emerald-700' : (isPast ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-700')}">
                            ${isCompleted ? '×‘×•×¦×¢' : (isPast ? '×‘××™×—×•×¨' : '×‘×”××ª× ×”')}
                        </span>
                    </td>
                    <td class="p-6">
                        <button onclick="toggleTask('${task.id}', ${isCompleted})" class="p-2 hover:bg-emerald-50 text-emerald-600">âœ“</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const score = totalRequiredToday > 0 ? Math.round((completedToday / totalRequiredToday) * 100) : 100;
            document.getElementById('currentScore').innerText = score + "%";
            document.getElementById('tasksCount').innerText = `${completedToday}/${expandedTasks.length}`;
        }

        async function toggleTask(id, currentStatus) {
            await supabase.from('tasks').update({ is_completed: !currentStatus }).eq('id', id);
            loadTasks();
        }

        function openNewTask() {
            document.getElementById('editId').value = '';
            document.getElementById('editTitle').value = '';
            document.getElementById('editRecur').value = '×—×“ ×¤×¢××™';
            toggleHourlyFields();
            document.getElementById('editModal').classList.add('open');
        }

        async function saveTask() {
            const recur = document.getElementById('editRecur').value;
            const data = {
                title: document.getElementById('editTitle').value,
                recurrence: recur,
                worker_name: document.getElementById('editWorker').value,
                is_completed: false
            };

            if (recur === '×©×¢×ª×™') {
                data.start_hour = document.getElementById('startHour').value;
                data.end_hour = document.getElementById('endHour').value;
                data.target_time = data.start_hour;
            } else {
                data.target_time = document.getElementById('editTime').value;
            }

            await supabase.from('tasks').insert([data]);
            closeEdit();
            loadTasks();
        }

        function closeEdit() { document.getElementById('editModal').classList.remove('open'); }
        function handleLogin() { 
            const u = document.getElementById('loginUser').value; 
            if(u){ localStorage.setItem('proTrackUser', u); location.reload(); }
        }
        function logout() { localStorage.removeItem('proTrackUser'); location.reload(); }
        function setPeriod(p) { renderTasks(); }

        init();
    </script>
</body>
</html>




